<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="unit"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(10em);grid-template-rows:1fr fit-content(1em)}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=view]{grid-area:1/1}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-area:1/2/span 2;padding:0 .5em 0 .5em}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=unit]{grid-area:2/1;line-height:1em;text-align:right;padding:.25em 0;white-space:nowrap}.pdl-layout.legend-bottom>div[data-type=layout]{grid-template-columns:1fr fit-content(1em);grid-template-rows:1fr fit-content(3em)}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=view]{grid-area:1/1 /auto/span 2}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{grid-area:2/1;padding-top:1em}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=unit]{grid-area:2/2;padding-top:1em}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"treemap",version:"0.0.1",extend:{name:"@makechart/base"},dependencies:[],i18n:{"zh-TW":{other:"其它",unit:"單位"}}},init:function(t){var e,n,r,i;e=t.root,n=t.context,r=t.pubsub,i=t.t;return r.fire("init",{mod:mod({root:e,context:n,t:i})})}};mod=function(t){var r,e,o,s,d,n,f;r=t.root,e=t.context,o=t.t;s=e.chart,d=e.d3,n=e.ldcolor,f=e.wrapSvgText;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50].map(function(t){return{val:Math.random().toFixed(2),cat1:Math.floor(1+5*Math.random()),cat2:["-","A","B","C","D","E","F","G"][Math.floor(1+4*Math.random())],cat3:["-","a","b","c","d","e","f","g"][Math.floor(1+3*Math.random())],name:["A","B","C","D","E","F"][Math.floor(Math.random()*6)]+"-"+Math.ceil(Math.random()*10)}}),binding:{color:{key:"cat"},area:{key:"val",unit:"MB"},name:{key:"name"},category:[{key:"cat1"},{key:"cat2"},{key:"cat3"}]}}},config:import$(s.utils.config.from({preset:"default",legend:"legend",label:"label"}),{unit:{position:{type:"choice",values:["inner","outside","none"]}},zoom:{enabled:{type:"boolean",default:false}}}),dimension:{color:{type:"RC",name:"顏色",priority:4},area:{type:"R",name:"面積",priority:1},name:{type:"NC",name:"名稱",priority:2},category:{type:"C",name:"分類",priority:3,multiple:true}},init:function(){var e,t,n,i=this;this.tint=e=new s.utils.tint;this.g=Object.fromEntries(["view","unit","legend"].map(function(t){return[t,d.select(i.layout.getGroup(t))]}));this.textRenderer=t=document.createElement("div");import$(t.style,{textAlign:"right",fontSize:"0.9em",padding:".5em .5em",lineHeight:"1.1em",whiteSpace:"pre-line",display:"inline-block",position:"absolute",top:0,left:0,opacity:0,pointerEvents:"none",userSelect:"none",zIndex:0});r.appendChild(t);this.legend=new s.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return d.select(this).attr("fill",e.get(t.key))},direction:((n=this.cfg).legend||(n.legend={})).position==="bottom"?"horizontal":"vertical",cfg:{selectable:true}});this.legend.on("select",function(){i.bind();i.resize();return i.render()});return this.tip=new s.utils.tip({root:this.root,accessor:function(t){var e,n,r;e=t.evt;if(!(e.target&&(n=d.select(e.target).datum()))){return null}r=isNaN(n.data.area)?"-":i.fmt(n.data.area)+""+(i.binding.area.unit||"");return{name:n.data.name,value:r}},range:function(){return i.layout.getNode("view").getBoundingClientRect()}})},destroy:function(){return this.tip.destroy()},parse:function(){var f,a,o=this;this.tint.reset();this.cat=f={size:0,hash:{root:{id:"root"}},depth:Array.isArray(this.binding.category)?(this.binding.category||[]).length||0:this.binding.category?1:0};this.parsed=this.data.map(function(t,e){var n,r,i,a,o,s,u,c,l,h,d;t=(n=import$({},t),n.id="id:"+e,n);for(r=(t.category||(t.category=[])).length-1;r>=0;--r){i=r;if(t.category[i]!=null&&t.category[i]!==""){break}}if(i!==t.category.length-1){t.category.splice(0,i+1)}a=f.hash.root;t.catobj=[];o=0;s=(t.category||[]).length;for(r=0,u=(n=t.category||[]).length;r<u;++r){c=n[r];l=a;a=(h=a.child||(a.child={}))[d="cat:"+c]||(h[d]={});if(a.id==null){a.id="cat:"+f.size++;a.name=c}c=o>=s/2?o-s:o;a.variant=c/(5*((t.category||[]).length+1));a.parent=l.id;t.catobj.push(a)}t.parent=a.id;return t});a=function(t,e){var n,r,i;e==null&&(e=[]);for(n in r=t.child||{}){i=r[n];a(i,e.concat([t]))}return o.parsed.push((t._cat=true,t.catobj=Array.from(e),t))};a(f.hash.root,[]);f.nodes=f.depth===0?[]:this.parsed.filter(function(t){return t._cat});return f.active="root"},bind:function(){var t,e,u,n,r=this;t=this.parsed;e=d.stratify().id(function(t){return t.id}).parentId(function(t){return t.parent});this.hierarchy=e(t);this.hierarchy=this.hierarchy.descendants().find(function(t){return t.id===r.cat.active});this.cat.curDepth=this.hierarchy.depth||0;u=function(t,e){var n,r,i,a,o,s=[];e==null&&(e=0);t.depth=e;n=0;for(r=0,a=(i=t.children||[]).length;r<a;++r){o=i[r];s.push(n+=u(o,e+1))}return s};u(this.hierarchy);n=this.cat.nodes.filter(function(t){return t.parent===r.cat.active&&t.name}).map(function(t){return{key:t.id,text:t.name}});n.sort(function(t,e){if(t.text<e.text){return-1}else if(t.text>e.text){return 1}else{return 0}});this.legend.data(n);if(n.length){return this.hierarchy.children=this.hierarchy.children.filter(function(t){return r.legend.isSelected(t.data.id)})}},resize:function(){var t,e,n,r,i,a=this;this.fmt=s.utils.format.from(this.cfg.label.format);this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",((t=this.cfg).legend||(t.legend={})).position==="bottom");this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);this.unit={inner:((t=this.cfg).unit||(t.unit={})).position==="inner"?this.binding.area.unit||"":"",outer:(t=((e=this.cfg).unit||(e.unit={})).position)==="inner"||t==="none"?"":this.binding.area.unit?o("unit")+": "+(this.binding.area.unit||""):""};n=this.layout.getNode("unit");n.style.display=!this.unit.outer?"none":"";n.textContent=this.unit.outer;this.legend.config(this.cfg.legend);this.legend.update();this.layout.update(false);this.hierarchy.sum(function(t){return t.area||0});r=this.layout.getBox("view");if(!(this.hierarchy.children||[]).length){delete this.hierarchy.children}((t=this.hierarchy).children||(t.children=[])).push({data:{}});i=d.treemap().padding(function(t){if(t.depth>=a.cat.depth-a.cat.curDepth){return 1}else{return 0}}).size([r.width,r.height]).tile(d.treemapBinary)(this.hierarchy);this.nodes=this.hierarchy.leaves().filter(function(t){return t.data._raw});this.nodes.map(function(t){return t._raw=t.data._raw});return this.extent=d.extent(this.nodes.map(function(t){return t.value}))},render:function(){var i,a,t,n,o,e,s,r,u,c,l,h=this;i=this.cfg,a=this.unit,t=this.binding,n=this.layout,o=this.textRenderer,e=this.tint,s=this.fmt;e.set(i.palette);r=function(t){var e;e=t.data.color!=null?[t.data.color]:[(t.data.catobj[h.cat.curDepth]||{}).id,0];return e};this.g.unit.call(function(){var t,e;t=n.getNode("unit");e=f({node:t,useRange:true});h.g.unit.node().textContent="";return h.g.unit.node().appendChild(e)});u=this.g.view.selectAll("rect.data").data(this.nodes,function(t){return t.data._idx});u.exit().attr("class","data exit").transition("remove-rect").duration(275).attr("x",function(t,e){return(t.x0+t.x1)/2}).attr("y",function(t,e){return(t.y0+t.y1)/2}).attr("width",0).attr("height",0).attr("opacity",0).remove();c=this;u.enter().append("rect").attr("class","data enter").attr("x",function(t){return(t.x1+t.x0)/2}).attr("y",function(t){return(t.y1+t.y0)/2}).attr("width",function(){return 0}).attr("height",function(){return 0}).attr("fill",function(t){return e.get.apply(e,r(t))}).style("opacity",0).on("dblclick",function(t){if(!(i.zoom||{}).enabled){return}if(c.zoomhdr){clearTimeout(c.zoomhdr)}c.cat.active="root";c.bind();c.resize();return c.render()}).on("click",function(t){var n=this;if(!(i.zoom||{}).enabled){return}if(c.zoomhdr){clearTimeout(c.zoomhdr)}c.zoomhdr=setTimeout(function(){var t,e;t=d.select(n).datum();if(!(e=t.data.catobj[c.cat.curDepth])){return}c.cat.active=e.id;c.bind();c.resize();return c.render()},350);return t.stopPropagation()});u.interrupt("remove-rect").attr("class","data enter");this.g.view.selectAll("rect.data.enter").transition("update-rect").duration(350).attr("x",function(t){return t.x0}).attr("y",function(t){return t.y0}).attr("width",function(t){return t.x1-t.x0}).attr("height",function(t){return t.y1-t.y0}).attr("fill",function(t){return e.get.apply(e,r(t))}).style("opacity",1);l=u=this.g.view.selectAll("g.label").data(this.nodes,function(t){return t.data._idx});l.exit().attr("class","label data exit").transition("remove-label").duration(275).style("opacity",0).remove();l.enter().append("g").attr("class","label data enter").attr("transform",function(t,e){return"translate("+t.x0+","+t.y0+")"}).style("opacity",0).style("pointer-events","none").style("cursor","pointer").style("font-size",i.font.size||"0.9em");u.interrupt("remove-label").attr("class","label data enter");this.g.view.selectAll("g.label.data.enter").each(function(t,e){var n,r;o.style.width=t.x1-t.x0+"px";o.style.fontSize=i.font.size||"0.9em";n=isNaN(t.data.area)?"-":s(t.data.area);o.innerHTML="<div>"+(t.data.name||"")+"</div>\n<div>"+n+a.inner+"</div>";r=f({node:o,useRange:true});this.textContent="";return this.appendChild(r)}).attr("transform",function(t,e){var n;n=(this.ox||0)+((this.ow||0)-(t.x1-t.x0));return"translate("+n+", "+(this.oy||0)+")"}).transition("label-update").duration(350).attr("transform",function(t,e){return"translate("+t.x0+","+t.y0+")"}).attr("fill",function(t){return e.text.apply(e,r(t))}).style("opacity",function(t,e){var n;n=this.getBBox();return n.width>t.x1-t.x0-5||n.height>t.y1-t.y0-5?0:1}).each(function(t,e){return this.ox=t.x0,this.oy=t.y0,this.ow=t.x1-t.x0,this});return this.legend.render()}}};function import$(t,e){var n={}.hasOwnProperty;for(var r in e)if(n.call(e,r))t[r]=e[r];return t}</script></div>